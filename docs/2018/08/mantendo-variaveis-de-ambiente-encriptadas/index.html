<!DOCTYPE html>
<html lang="pt-br" class="wf-firasans-n4-active wf-active">
	<head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Enable responsiveness on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    <meta name="generator" content="Hugo 0.46" />
    
    <title>Mantendo variáveis de ambiente encriptadas &middot; </title>
    <meta content="Mantendo variáveis de ambiente encriptadas - " property="og:title">
    <meta content=" - " property="og:description">
    <!-- CSS -->
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i|Roboto+Mono:300,300i,400,400i" rel="stylesheet">
    <link rel="stylesheet" href="https://daltonmatos.com/css/print.css" media="print">
    <link rel="stylesheet" href="https://daltonmatos.com/css/poole.css">
    <link rel="stylesheet" href="https://daltonmatos.com/css/hyde.css">
    <link rel="stylesheet" href="https://daltonmatos.com/css/syntax.css">
    <!-- Font-Awesome -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/all.js" integrity="sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe" crossorigin="anonymous"></script>
    <!-- highlight.js-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/Monokai.min.css">
    <!-- Customised CSS -->
    <link rel="stylesheet" href="https://daltonmatos.com/css/custom.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

	</head>
    <body class="theme-base-08 ">
        <div class="sidebar">
  <div class="container text-center ">
    <div class="sidebar-about text-center">
      <a href="https://daltonmatos.com/"><h1 class="brand"></h1></a>
       <img src="/daltonmatos.jpeg" alt="Author Image" class="img-circle headshot center"> 
      <p class="lead">
         Dalton Barreto 
      </p>
    </div>
    
<div>
	<ul class="sidebar-nav">
		
		
				<li>
					<a href="/"> <span>Home</span></a>
				</li>
				<li>
					<a href="/gpg/"> <span>GPG Public Key</span></a>
				</li>
				<li>
					<a href="/about/"> <span>About</span></a>
				</li>
		</li>
	</ul>
</div>

    <p>
      <section class="row text-center">
	
	<a href="https://twitter.com/daltonmatos"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://github.com/daltonmatos"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
</section>

    </p>
    <p class="copyright">&copy; 2018 Dalton Barreto.
      <a href="https://creativecommons.org/licenses/by/4.0">Some Rights Reserved</a>.<br/>Built with <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            <div class="post">
  <h1>Mantendo variáveis de ambiente encriptadas</h1>
  
  <div class="col-sm-12 col-md-12">
    <span class="text-left post-date meta">
            
       
        <i class="fas fa-calendar-alt"></i> Aug 16, 2018
      
      
      
      
        
        
            <br/>
             <i class="fas fa-tags"></i>
            
            <a class="meta" href="/tags/crypt">crypt</a> 
        
            <a class="meta" href="/tags/gnupg">gnupg</a> 
        
            <a class="meta" href="/tags/gpg">gpg</a> 
        
            <a class="meta" href="/tags/shell">shell</a>
        
      
      
      <br/>
      <i class="fas fa-clock"></i> 5 min read 
      </span>  
  </div>    
  
  

<p>Desde que me interessei mais sobre encriptação, chaves GPG e afins comecei a tentar montar um workflow que fosse ao mesmo tempo agradável e seguro (para os padrões que escolhi).
Depois de ter começado a usar um <a href="/tags/yubikey">smartcard</a> para armazenar minhas chaves (<a href="/2018/07/preparando-uma-yubikey-4-nano-para-uso-diario/">[1]</a> e <a href="/2018/08/usando-seu-keyring-gpg-para-guardar-sua-chave-ssh/">[2]</a>) comecei a usá-lo em vários pontos do meu dia a dia que achei que deveriam/poderiam ser mais seguros.</p>

<h1 id="variáveis-de-ambiente">Variáveis de ambiente</h1>

<p>Variáveis de ambiente, ou apenas <code>ENVs</code> são muito comuns no dia a dia de quem lida com desenvolvimento. Seja para passar parametros para o seu código ou para configurar seu shell, elas estão lá muitas vezes até mesmo sem a gente se dar conta.</p>

<p>Por muito tempo guardei credenciais de acesso em <code>ENVs</code>, por pura praticidade. Afinal, não precisaria decorar nenhum daqueles valores e poderia, com um comando, resgatá-los e usar quando necessário.  Mas o problema é que esses valores ficam guardados em texto plano. Isso é análogo a anotarmos a senha do nosso cartão do banco em uma arquivo <code>txt</code> dentro do nosso computador, e não fazemos isso né?</p>

<p>Por isso faz um tempo que pensei em qual seria o custo de manter todas as minhas <code>ENVs</code> encriptadas e mais, queria continuar dependendo apenas de um comando para recuperar seus valores e usá-los.</p>

<h1 id="encriptando-suas-variáveis-de-ambiente">Encriptando suas Variáveis de ambiente</h1>

<p>A encriptação não sem nenhum mistério, é passar um valor para o <code>gnupg</code> e guardar o resultado na <code>ENV</code> desejada. Como o resultado da encriptação é um valor multi-linha, precisamos manter esse &ldquo;formato&rdquo;. Aqui está um exemplo de como gerar uma variável dessas.</p>

<p>Aqui vamos apenas chamar o comando mostrado, colar o conteúdo a ser encriptado e dar um <code>Enter</code>.</p>

<p>Depois pressione <code>^D</code> (<code>Ctrl+d</code>). Precisamos disso porque o <code>gnupg</code> está lendo do <code>stdin</code> e o <code>^D</code> é o sinal de que a entrada terminou.</p>

<pre><code>$ gpg -e -r daltonmatos@gmail.com
AQUI VAI O CONTEÚDO SENSÍVEL
-----BEGIN PGP MESSAGE-----

hQIMA0V2jZ1vFNR0AQ/+IH3DEZZJ8dLefN1BHxUtiod5nniKD/JUrD9WUIv8fny4
pIfMHdOppfyFH57P4+nAFN10dn09iRqPEiGMl2C2OiyLKapW9FmR5P9JutRDK4bE
BkOoJyxVtIOJQNsixbUcvxQJzWovnOEXklV/F++OntzpwvKln5BHdmAIFKJ1kUbd
jiaJsySezqktQxV1o0qwILQjTJNlsig4sOGljyfzlicI09fp/+zHXvunw+Wo3zND
LKwun1xbpg8ppepl1WSBTP00cf2OdMdyAts3JYNA7A0x+I1NLqJ3lfn9gtJ6YErU
zqcT8Ac8jivaCzWq4CArb7YrSV904okHz/OreJg0nbcKXlbR4SYND0aFGQMek+Yl
WbNODvKL2Q3FABECsOAtmPtYLn3kLrqcuz5RKacCs0jfxS5N6p7b6VI6ZpX39Z+3
1Ox3JBkXKmZDs26MSUvX4tFZGSl8K9Sf+rB3dlF+F8wBHbhhTWl6AlLSGFrtZXlW
4jFXn/3BAEmF8UzfV0VDtuVApXbqgQLzelb/oaO/tdr2zzUqluq0c5L63LacKSzt
3y33+bJL4ezLPWXCUtLvu4n0Krl2UYVJZJuy9rVaGguP/MYKjFp5pfCy8XjYUE0v
U4QzWxVe9RNAmhe0fW0ivjuMNtzlS7BqAwTqMugzBeWw8/uXoT4tCtCqAJF4eMTS
QgFVR9Ybw5m1IANObGBPKBdwAMkd4wsYNvjPGNgu5S01YGbt+qjt/P9JhZzAvSxO
pPWRurxuZxJmRsUJy1gzQrUbcA==
=lCiu
-----END PGP MESSAGE-----
</code></pre>

<p>Agora salvamos isso em algum arquivo que será importado pelo nosso shell. Eu tenho essas (e outras) coisas em um arquivo <code>~/.shell-extras</code>, mas pode ser em qualquer lugar, desde que seja importado pelo seu shell.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">export</span> <span class="nv">CRYPT_API_AUTH_TOKEN</span><span class="o">=</span><span class="s2">&#34;
</span><span class="s2">-----BEGIN PGP MESSAGE-----
</span><span class="s2">
</span><span class="s2">hQIMA0V2jZ1vFNR0AQ/9FqSgxyz5hdrwTiYNEkvPf4s+IvXophjbR9dxfRj2shYq
</span><span class="s2">KNRNa9uXy3dvOO8A622svXwHqaOrkbwCdzDqNCP2pBArXASCHVsLagjA+s5TNAQc
</span><span class="s2">2bcyEVdmxxMK3ldXA5dJtoc68NH0sJztmtA9cLt9OhCOZ6SA/gw8cn7+4uLjsT20
</span><span class="s2">olHrLAKboxiO5HuCQ9TiqLOLBgvjCGqUt3aI25wP+hTkL/qgrE4V+TcgRc7kFjZc
</span><span class="s2">B0DATPo8Gt3P+D358Y/BoKLVkaxM03CEdIjv81JEc/5EQhCzFabzN0WsP00H9mHD
</span><span class="s2">sq0PWGDAbTR/R4jBJDPJ7l0Yoj/lvzMPRtc+JcS26vHYmABJlGUSJeSZccwVe2k2
</span><span class="s2">FZgK1XJDCYMThr2XKjU2TEOWJhQVUbPusshFh7FOY8NEBEH8pbyrhVptt3wMsjVl
</span><span class="s2">ooyYS9bmrTxn+XAE60WlGSsTpGBmYJ+uolicMq7Pc0kY5RfIBPf2z0ZcD/mM95T6
</span><span class="s2">fbtDEh1d0zCSW1e6LnZmkLMDCo5oON5LheuVRMOEFgmXJ+CdYtfk9oGB2m+PBZeL
</span><span class="s2">okERrJPGDcoto57WZTURRvQVIgDeDPzMA/R04+6IgOgenMYTPuw2wEYLqBWrp4+t
</span><span class="s2">ndgfLejrMWiI2CKE6xRMbmTyNcGwi1g+9g0qhQeJy4ZwNX+kcve1hPHpzaFww+zS
</span><span class="s2">QgEd+8nKUazScIobLjhtJwOAqwKe0dJN23Mw50OFFAmSndjBcWeJD+Hb820wUZV7
</span><span class="s2">mMFvsc7xLBzsdsioIQCQdnEwHQ==
</span><span class="s2">=JCIv
</span><span class="s2">-----END PGP MESSAGE-----
</span><span class="s2">&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>Para fazer um teste rápido podemos rodar:</p>

<pre><code>printenv CRYPT_API_AUTH_TOKEN | gpg -d
gpg: encrypted with 4096-bit RSA key, ID 45768D9D6F14D474, created 2017-09-14
      &quot;Dalton Barreto &lt;daltonmatos@gmail.com&gt;&quot;
AQUI VAI O CONTEÚDO SENSÍVEL
</code></pre>

<p>Isso vai nos dar o resultado original. Essa é a confirmação de que tudo está correto e já podemos usar esse valor em quaisquer comandos em nosso shell prompt (ou script!).</p>

<h1 id="usando-uma-variável-em-um-comando-qualquer">Usando uma variável em um comando qualquer</h1>

<p>O uso na linha de comando é bem simples, na verdade o que temos que fazer é encaixar esse <code>printnev</code> que fizemos aí em cima no meio da linha de comando onde precisamos usar o valor sensível. Algo assim:</p>

<pre><code>curl -H &quot;X-Secret: $(printenv CRYPT_API_AUTH_TOKEN| gpg -d)&quot; https://httpbin.org/headers            
gpg: encrypted with 4096-bit RSA key, ID 45768D9D6F14D474, created 2017-09-14
      &quot;Dalton Barreto &lt;daltonmatos@gmail.com&gt;&quot;
{
  &quot;headers&quot;: {
    &quot;Accept&quot;: &quot;*/*&quot;, 
    &quot;Connection&quot;: &quot;close&quot;, 
    &quot;Host&quot;: &quot;httpbin.org&quot;, 
    &quot;User-Agent&quot;: &quot;curl/7.61.0&quot;, 
    &quot;X-Secret&quot;: &quot;AQUI VAI O CONTEÚDO SENSÍVEL&quot;
  }
}
</code></pre>

<p>Veja como o header <code>X-Secret</code> foi enviado contendo o valor da nossa <code>ENV</code>, já decriptado.</p>

<h2 id="facilitando-o-uso-desses-valores-em-nossos-comandos">Facilitando o uso desses valores em nossos comandos</h2>

<p>Para não precisar digitar todo esse comando do <code>printenv</code> sempre que precisar usar alguma <code>ENV</code>, escrevi uma shell function que facilita esse uso. Chamei essa function de <code>decrypt_env</code>. O que ela recebe como parametro é apenas o nome da env e retorna seu valor, decriptado.</p>

<p>Para poder diferenciar, pelo nome, envs que são encriptadas sempre uso o prefixo <code>CRYPT_</code> em todas as <code>ENVs</code> que possuem conteúdo encriptado. Essa shell function é bem simples:</p>

<pre><code>decrypt_env() {
  local env_name_sufix=$1
  local env_name=CRYPT_${env_name_sufix}
  gpg -d &lt;&lt;&lt;${(P)env_name} 2&gt;/dev/null
}
</code></pre>

<p>Esse código está no meu <a href="https://github.com/daltonmatos/dotfiles/blob/master/zsh/zshrc#L194-L198">dotfiles</a>.</p>

<p>De posse dessa função, nossa linha de comando de exemplo ficaria assim:</p>

<pre><code>curl -H &quot;X-Secret: $(decrypt_env API_AUTH_TOKEN)&quot; https://httpbin.org/headers           
{
  &quot;headers&quot;: {
    &quot;Accept&quot;: &quot;*/*&quot;, 
    &quot;Connection&quot;: &quot;close&quot;, 
    &quot;Host&quot;: &quot;httpbin.org&quot;, 
    &quot;User-Agent&quot;: &quot;curl/7.61.0&quot;, 
    &quot;X-Secret&quot;: &quot;AQUI VAI O CONTEÚDO SENSÍVEL&quot;
  }
}
</code></pre>

<p>Perceba que passamos apenas o &ldquo;nome&rdquo; da env, sem mencionar o prefixo <code>CRYPT_</code>. Outra coisa que a function faz é suprimir o que o <code>gnupg</code> imprime no <code>stderr</code>, apenas para não termos eventuais problemas, já que estáriamos alterando o <code>stderr</code> do shell e essa function deveria ser totalmente transparente.</p>

<p><strong>Nota</strong>: Confesso que tentei, em algum momento, escrever um auto-complete para o zsh, mas falhei. Talvez eu volte nisso algum dia. =)</p>

<h1 id="histórico-do-shell">Histórico do shell</h1>

<p>Uma vantagem colateral dessa abordagem é que os valores sensíveis que estão nessas <code>ENVs</code> <strong>não ficam</strong> no histórico do seu shell, afinal lá só estará o comando com a chamada à função <code>decrypt_env()</code>. Nesse caso não temos nenhum vazamento de informações sobre seus valores sensíveis.</p>

<p>Atualmente todas as minhas <code>ENVs</code> sensíveis estão encriptadas e isso me faz sentir mais seguro em relação ao que pode ser lido em um eventual acesso à minha estação de trabalho ou computador pessoal.</p>

</div>
            <div class="footer">
                <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

<script type="text/javascript">
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
</script>

    

            </div>
        </div>
        
        
    </body>
</html>
